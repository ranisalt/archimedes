#!/usr/bin/bash -x

chroot="/mnt"

### PACKAGE SELECTION ###
# Bootloader. Please change the bootloader function if you change it.
packages="${packages} base-devel syslinux"

# Some daemons, clients and related packages
packages="${packages} openssh wicd"

# X.Org and related packages
packages="${packages} slim xorg-{server,setxkbmap,xinit,xrdb}"

# DE stuff
packages="${packages} conky dmenu i3-wm i3lock i3status ranger wicd-curses"

# Useful things
packages="${packages} firefox fish git vim"

# CHECK MIRROR CONNECTION
if ! ping -c 1 150.162.66.161 &>/dev/null
then
	echo "Could not connect to 150.162.66.161, please check cables or change IP"
	exit 69
fi

uefi=$([ -d /sys/firmware/efi ])
$uefi && bootfs="fat32" || bootfs="ext4"

alias mkfs.fat32="mkfs.vfat -F32"

# PARTITIONING AND LABELING
partitioning() {
	parted -s -- /dev/sda mklabel gpt
	parted -s --align optimal -- /dev/sda \
		mkpart primary ${bootfs} 0% 200MiB \
		mkpart primary ext4 200MiB 10% \
		mkpart primary ext4 10% -4GB\
		mkpart primary swap -4GB 100% \
		set 1 boot on

	yes | {
		mkfs.${bootfs} -L BOOT /dev/sda1
		mkfs.ext4 -L ROOT /dev/sda2
		mkfs.ext4 -L HOME /dev/sda3
		mkswap -L SWAP /dev/sda4
	}
}

# MOUNT PARTITIONS
# Labels are useful
mount_partitions() {
	mount -L ROOT ${chroot}
	mkdir -p ${chroot}/boot
	mount -L BOOT ${chroot}/boot
	mkdir -p ${chroot}/home
	mount -L HOME ${chroot}/home
	swapon -L SWAP
}

# BOOTSTRAP
# Configure mirrorlist and run pacstrap
# This is a personal choice mirror. It's 500 meters from home and I get <5ms ping.
bootstrap() {
	cat <<-EOF > /etc/pacman.d/mirrorlist
		Server = http://pet.inf.ufsc.br/mirrors/archlinux/\$repo/os/\$arch
	EOF
	pacstrap ${chroot} base $(eval echo -e ${packages})
}

# CONFIGURE FILES
configure() {
	# -no means --noheadings and --output, but it's funny like that
	root=$(lsblk -no PARTUUID `blkid -L ROOT`)
	boot=$(lsblk -no PARTUUID `blkid -L BOOT`)
	home=$(lsblk -no PARTUUID `blkid -L HOME`)
	swap=$(lsblk -no PARTUUID `blkid -L SWAP`)

	[ "x${bootfs}" == "xfat32" ] && bootfs="vfat"
	# I do not use genfstab because I need a more fine grained approach
	cat <<-EOF > ${chroot}/etc/fstab
		# LOCAL MOUNTS
		# Disable automount on /boot increases security, and letting systemd handle makes it more comfortable :)
		PARTUUID="${boot}" /boot ${bootfs} noatime,noauto,nodev,noexec,nosuid,x-systemd.automount 0 2
		# If on SSD, add commit=60
		PARTUUID="${home}" /home ext4 noatime,noauto,x-systemd.automount 0 0
		PARTUUID="${swap}" swap swap defaults 0 0
	EOF

	cat <<-EOF > ${chroot}/etc/X11/xorg.conf.d/20-keyboard.conf
		Section "InputClass"
			Identifier "system-keyboard"
			MatchIsKeyboard "on"
			Option "XkbModel" "pc105"
			Option "XkbLayout" "br"
			Option "XkbVariant" "abnt2"
		EndSection
	EOF

	echo -n "What is the desired machine hostname?"
	read -er hostname
	echo ${hostname} > ${chroot}/etc/hostname

	sed -i 's/#\(en_US.UTF-8\)/\1/' ${chroot}/etc/locale.gen
	echo LANG=en_US.UTF-8 > ${chroot}/etc/locale.conf

	cat <<-EOF > ${chroot}/etc/systemd/timesyncd.conf
		[Time]
		NTP=ntp.ufsc.br
		FallbackNTP=0.arch.pool.ntp.org 1.arch.pool.ntp.org 2.arch.pool.ntp.org 3.arch.pool.ntp.org
	EOF

	# Configure mkinitcpio to use LZ4. It's faster.
	sed -i 's/^\(COMPRESSION\)/#\1/g' ${chroot}/etc/mkinitcpio.conf
	sed -i 's/^#\(COMPRESSION="lz4"\)/\1/' ${chroot}/etc/mkinitcpio.conf

	# Let wheel users become use sudo
	sed -i 's/^#.*?\(%wheel ALL=(ALL) ALL\)/\1/' ${chroot}/etc/sudoers
}

# CONFIGURE ON CHROOT
# Does some things other than write to files
configure_chroot() {
	# Generate locales
	arch-chroot ${chroot} locale-gen

	# Symlink timezone
	arch-chroot ${chroot} ln -sf /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime

	# Read and store common user and password
	echo -n "What is the desired username?"
	read -er username
	arch-chroot ${chroot} useradd -m -G audio,users,video,wheel ${username}
	echo -n "What is the desired ${username} password?"
	read -ers password

	# Read and store root password
	echo -n "What is the desired root password?" 
	read -ers rootpw
	arch-chroot ${chroot} chpasswd <<-EOF
		root:$rootpw
		$username:$password
	EOF
	unset rootpw

	arch-chroot ${chroot} systemctl enable slim.service wicd.service
}

# INSTALL BOOTLOADER
install_bootloader_uefi() {
	mkdir -p ${chroot}/boot/EFI/syslinux
	arch-chroot ${chroot} cp -r /usr/lib/syslinux/efi64/* /boot/EFI/syslinux
	efibootmgr -c -d /dev/sda -p 1 /l /EFI/syslinux/syslinux.efi -L "Syslinux"

	# Fix retarded hardcoded default
	sed -i 's/sda3/sda2/' ${chroot}/boot/EFI/syslinux/syslinux.cfg
}

install_bootloader_bios() {
	syslinux-install_update -i -a -m -c ${chroot}

	# Fix retarded hardcoded default
	sed -i 's/sda3/sda2/' ${chroot}/boot/syslinux/syslinux.cfg
}

partitioning
mount_partitions
bootstrap
configure
configure_chroot
$uefi && install_bootloader_uefi || install_bootloader_bios
